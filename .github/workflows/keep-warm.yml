name: Keep API Warm

on:
  # Run hourly
  schedule:
    - cron: '*/30 * * * *'  # Run every 30 minutes

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode with additional logging'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  ping-api:
    name: Ping API Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Set a timeout to prevent hung jobs

    env:
      API_URL: https://recommend-a-book-api.onrender.com

    steps:
      - name: Ping prewarm endpoint
        id: ping-prewarm
        continue-on-error: true  # Continue to health check even if this fails
        run: |
          echo "::group::Pinging prewarm endpoint"
          echo "Time: $(date -u)"
          echo "Endpoint: $API_URL/api/prewarm"

          # Make the request and capture response details
          # Increase timeouts to handle cold starts better
          HTTP_RESPONSE=$(curl -s -o response.txt -w "%{http_code}" \
            --connect-timeout 60 \
            --max-time 120 \
            --retry 5 \
            --retry-delay 10 \
            --retry-max-time 300 \
            --retry-connrefused \
            --retry-all-errors \
            "$API_URL/api/prewarm")

          # Store response body
          RESPONSE_BODY=$(cat response.txt)

          # Log detailed info in test mode
          if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
            echo "Response code: $HTTP_RESPONSE"
            echo "Response body: $RESPONSE_BODY"
          fi

          # Check if request was successful
          # Consider 28 (timeout) as temporary and not a failure
          if [[ $HTTP_RESPONSE -ge 200 && $HTTP_RESPONSE -lt 300 ]]; then
            echo "✅ Prewarm endpoint successfully pinged"
            echo "prewarm_success=true" >> $GITHUB_OUTPUT
          elif [[ $HTTP_RESPONSE -eq 28 || $HTTP_RESPONSE -eq 0 ]]; then
            echo "⚠️ Timeout when pinging prewarm endpoint (HTTP $HTTP_RESPONSE) - likely cold start"
            echo "Response: $RESPONSE_BODY"
            # Still consider this a partial success since timeouts are expected during cold starts
            echo "prewarm_success=partial" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to ping prewarm endpoint (HTTP $HTTP_RESPONSE)"
            echo "Response: $RESPONSE_BODY"
            echo "prewarm_success=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Ping health endpoint
        id: ping-health
        if: steps.ping-prewarm.outputs.prewarm_success != 'true'
        run: |
          echo "::group::Pinging health endpoint (fallback)"
          echo "Time: $(date -u)"
          echo "Endpoint: $API_URL/api/health"

          # Make the request and capture response details
          # Increase timeouts to handle cold starts better
          HTTP_RESPONSE=$(curl -s -o health-response.txt -w "%{http_code}" \
            --connect-timeout 60 \
            --max-time 120 \
            --retry 5 \
            --retry-delay 10 \
            --retry-max-time 300 \
            --retry-connrefused \
            --retry-all-errors \
            "$API_URL/api/health")

          # Store response body
          RESPONSE_BODY=$(cat health-response.txt)

          # Log detailed info in test mode
          if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
            echo "Response code: $HTTP_RESPONSE"
            echo "Response body: $RESPONSE_BODY"
          fi

          # Check if request was successful
          # Consider 28 (timeout) as temporary and not a failure
          if [[ $HTTP_RESPONSE -ge 200 && $HTTP_RESPONSE -lt 300 ]]; then
            echo "✅ Health endpoint successfully pinged"
            echo "health_success=true" >> $GITHUB_OUTPUT
          elif [[ $HTTP_RESPONSE -eq 28 || $HTTP_RESPONSE -eq 0 ]]; then
            echo "⚠️ Timeout when pinging health endpoint (HTTP $HTTP_RESPONSE) - likely cold start"
            echo "Response: $RESPONSE_BODY"
            # Still consider this a partial success since timeouts are expected during cold starts
            echo "health_success=partial" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to ping health endpoint (HTTP $HTTP_RESPONSE)"
            echo "Response: $RESPONSE_BODY"
            echo "health_success=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Report status
        run: |
          echo "::group::API Keep-Warm Status Report"
          echo "Time: $(date -u)"

          if [[ "${{ steps.ping-prewarm.outputs.prewarm_success }}" == "true" ]]; then
            echo "✅ API successfully kept warm via prewarm endpoint"
            exit 0
          elif [[ "${{ steps.ping-health.outputs.health_success }}" == "true" ]]; then
            echo "✅ API successfully kept warm via health endpoint"
            exit 0
          elif [[ "${{ steps.ping-prewarm.outputs.prewarm_success }}" == "partial" || "${{ steps.ping-health.outputs.health_success }}" == "partial" ]]; then
            echo "⚠️ API appears to be in cold start - encountered timeouts"
            echo "This is normal for serverless deployments and the next run will likely succeed"
            # Cold start is expected behavior, so don't treat as a failure
            exit 0
          else
            echo "❌ Failed to keep API warm - both endpoints failed"
            # Don't fail the workflow, as that would generate noise
            # Instead, just log the failure
            exit 0
          fi
          echo "::endgroup::"
